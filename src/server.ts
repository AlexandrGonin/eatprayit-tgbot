import { Bot, webhookCallback } from 'grammy';
import express from 'express';
import { 
  createUser, 
  getUserByTelegramId, 
  getUserByReferralCode, 
  addReferral, 
  getReferralLink,
  activateUser
} from './database/supabase';

const app = express();
const PORT = process.env.PORT || 3000;
const BOT_TOKEN = process.env.BOT_TOKEN;

if (!BOT_TOKEN) {
  console.error('‚ùå BOT_TOKEN not found');
  process.exit(1);
}

const bot = new Bot(BOT_TOKEN);

app.use(express.json());

app.get('/', (req, res) => {
  res.json({ status: 'Bot is running', timestamp: new Date().toISOString() });
});

app.get('/health', (req, res) => {
  res.json({ status: 'healthy' });
});

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.command('start', async (ctx) => {
  try {
    const telegramId = ctx.from?.id;
    const username = ctx.from?.username;
    const firstName = ctx.from?.first_name;
    const lastName = ctx.from?.last_name;
    
    if (!telegramId || !firstName) {
      return await ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
    }

    const referralCode = ctx.match;
    console.log('üîç Start command:', { telegramId, referralCode });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const existingUser = await getUserByTelegramId(telegramId);
    
    if (existingUser) {
      console.log('‚úÖ Existing user found:', existingUser);
      
      if (referralCode && !existingUser.is_active) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω + –ø—Ä–∏—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ
        return await ctx.reply('‚ùå –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –±–µ–∑ —Å—Å—ã–ª–∫–∏.');
      }
      
      if (referralCode && existingUser.is_active) {
        // –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ
        return await ctx.reply('‚ùå –í—ã —É–∂–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏.');
      }
      
      if (!existingUser.is_active && !referralCode) {
        // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Å—Å—ã–ª–∫–∏
        return await ctx.reply(`üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${firstName}!\n\n` +
          `‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App.\n\n` +
          `üîë –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –¥—Ä—É–≥–∞.\n\n` +
          `üìã –ö–æ–º–∞–Ω–¥—ã:\n/status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\n/help - –ü–æ–º–æ—â—å`);
      }
      
      // –ê–ö–¢–ò–í–ù–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨
      const referralLink = await getReferralLink(telegramId, ctx.me.username);
      
      let welcomeMessage = `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${firstName}!\n\n` +
        `‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App!\n\n` +
        `üí∞ –ú–æ–Ω–µ—Ç—ã: ${existingUser.coins}\n` +
        `üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${existingUser.referral_count}\n\n` +
        `üìã –ö–æ–º–∞–Ω–¥—ã:\n/status - –°—Ç–∞—Ç—É—Å\n/referral - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞\n/help - –ü–æ–º–æ—â—å`;

      if (referralLink) {
        welcomeMessage += `\n\nüéØ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}`;
      }

      await ctx.reply(welcomeMessage);
      
    } else {
      // –ù–û–í–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨
      console.log('üÜï New user detected');
      
      if (!referralCode) {
        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Å—Å—ã–ª–∫–∏
        return await ctx.reply(`üëã –ü—Ä–∏–≤–µ—Ç, ${firstName}!\n\n` +
          `‚ùå –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App –Ω—É–∂–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞.\n\n` +
          `üîë –ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Å—Å—ã–ª–∫—É —É –¥—Ä—É–≥–∞.\n\n` +
          `üìã –ö–æ–º–∞–Ω–¥—ã:\n/help - –ü–æ–º–æ—â—å`);
      }
      
      // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π
      console.log('üîó Referral code:', referralCode);
      const referrer = await getUserByReferralCode(referralCode);
      console.log('üë§ Referrer found:', referrer);
      
      if (!referrer) {
        return await ctx.reply('‚ùå –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
      }

      if (!referrer.is_active) {
        return await ctx.reply('‚ùå –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.');
      }
      
      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const newUser = await createUser(telegramId, username || null, firstName, lastName || null);
      console.log('‚úÖ New user created:', newUser);
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await activateUser(telegramId);
      console.log('‚úÖ User activated');
      
      // –ù–∞—á–∏—Å–ª—è–µ–º –º–æ–Ω–µ—Ç—ã —Ä–µ—Ñ–µ—Ä–µ—Ä—É
      await addReferral(referrer.telegram_id);
      console.log('‚úÖ Referral added');
      
      const welcomeMessage = `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${firstName}!\n\n` +
        `‚úÖ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App!\n\n` +
        `üí∞ –í–∞—à–∏ –º–æ–Ω–µ—Ç—ã: ${newUser.coins}\n` +
        `üë• –í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: ${referrer.first_name}\n\n` +
        `üìã –ö–æ–º–∞–Ω–¥—ã:\n/status - –°—Ç–∞—Ç—É—Å\n/referral - –í–∞—à–∞ —Å—Å—ã–ª–∫–∞\n/help - –ü–æ–º–æ—â—å\n\n` +
        `üéØ –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π!`;

      await ctx.reply(welcomeMessage);
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
      try {
        await ctx.api.sendMessage(
          referrer.telegram_id, 
          `üéâ –í–∞—à –¥—Ä—É–≥ ${firstName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ!\n\n` +
          `üí∞ –í—ã –ø–æ–ª—É—á–∏–ª–∏ +1 –º–æ–Ω–µ—Ç—É!\n` +
          `üë• –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${referrer.referral_count + 1}`
        );
      } catch (error) {
        console.error('Error notifying referrer:', error);
      }
    }
    
  } catch (error) {
    console.error('üí• Error in /start:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /status
bot.command('status', async (ctx) => {
  try {
    const telegramId = ctx.from?.id;
    if (!telegramId) return;

    const user = await getUserByTelegramId(telegramId);
    if (!user) {
      return await ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
    }

    let statusMessage = `üìä –í–∞—à —Å—Ç–∞—Ç—É—Å:\n\n`;

    if (!user.is_active) {
      statusMessage += `‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App\n\n` +
        `üîë –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç –¥—Ä—É–≥–∞\n\n`;
    } else {
      statusMessage += `‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App\n\n`;
    }

    statusMessage += `üí∞ –ú–æ–Ω–µ—Ç—ã: ${user.coins}\n` +
      `üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${user.referral_count}\n` +
      `üéØ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ${user.referral_code}\n\n`;

    if (user.is_active && user.referral_count > 0) {
      const referralLink = `https://t.me/${ctx.me.username}?start=${user.referral_code}`;
      statusMessage += `üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n` +
        `–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ!`;
    } else if (user.is_active) {
      const referralLink = `https://t.me/${ctx.me.username}?start=${user.referral_code}`;
      statusMessage += `üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n` +
        `–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–æ–Ω–µ—Ç—ã!`;
    } else {
      statusMessage += `üìä –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App!`;
    }

    await ctx.reply(statusMessage);
  } catch (error) {
    console.error('üí• Error in /status:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /referral
bot.command('referral', async (ctx) => {
  try {
    const telegramId = ctx.from?.id;
    if (!telegramId) return;

    const user = await getUserByTelegramId(telegramId);
    if (!user) {
      return await ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ Mini App
    if (!user.is_active) {
      return await ctx.reply('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App.\n\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∞.');
    }

    // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø
    const referralLink = `https://t.me/${ctx.me.username}?start=${user.referral_code}`;
    
    const referralMessage = `üéØ –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n\n${referralLink}\n\n` +
      `–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ!\n\n` +
      `üí∞ –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –º–æ–Ω–µ—Ç—ã: ${user.coins}\n` +
      `üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: ${user.referral_count}\n\n` +
      `–í–∞—à–∏ –¥—Ä—É–∑—å—è –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø –∫ Mini App –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ!`;
    
    await ctx.reply(referralMessage);

  } catch (error) {
    console.error('üí• Error in /referral:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.command('help', async (ctx) => {
  try {
    const helpMessage = `
ü§ñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
/status - –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à —Å—Ç–∞—Ç—É—Å –∏ –º–æ–Ω–µ—Ç—ã
/referral - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ

üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –¥—Ä—É–≥–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start —Å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /referral —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é —Å—Å—ã–ª–∫—É
4. –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ

üì± Mini App –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π!
    `;
    
    await ctx.reply(helpMessage);
  } catch (error) {
    console.error('üí• Error in /help:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (ctx) => {
  if (ctx.message.text && !ctx.message.text.startsWith('/')) {
    await ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.');
  }
});

// Webhook endpoint
app.post('/webhook', webhookCallback(bot, 'express'));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err) => {
  console.error('üí• Bot error:', err);
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
  console.log(`üöÄ Bot server running on port ${PORT}`);
  console.log(`üåê Health check: http://localhost:${PORT}/health`);
});

// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º webhooks, –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö
if (process.env.RENDER_EXTERNAL_URL) {
  const webhookUrl = `${process.env.RENDER_EXTERNAL_URL}/webhook`;
  bot.api.setWebhook(webhookUrl).then(() => {
    console.log(`‚úÖ Webhook set to: ${webhookUrl}`);
  }).catch(console.error);
}