import { Bot, webhookCallback } from 'grammy';
import express from 'express';
import { 
  createUser, 
  getUserByTelegramId, 
  getUserByReferralCode, 
  addReferral, 
  getReferralLink 
} from './database/supabase';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express
const app = express();
const PORT = process.env.PORT || 3000;
const BOT_TOKEN = process.env.BOT_TOKEN;

if (!BOT_TOKEN) {
  console.error('‚ùå BOT_TOKEN not found');
  process.exit(1);
}

const bot = new Bot(BOT_TOKEN);

// Middleware
app.use(express.json());

// Health check endpoint
app.get('/', (req, res) => {
  res.json({ 
    status: 'Bot is running', 
    timestamp: new Date().toISOString(),
    service: 'Telegram Bot Webhook'
  });
});

app.get('/health', (req, res) => {
  res.json({ status: 'healthy' });
});

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.command('start', async (ctx) => {
  try {
    console.log('Received /start command from:', ctx.from?.id);
    
    const telegramId = ctx.from?.id;
    const username = ctx.from?.username;
    const firstName = ctx.from?.first_name;
    const lastName = ctx.from?.last_name;
    
    if (!telegramId || !firstName) {
      return await ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
    }

    const referralCode = ctx.match;
    let referredBy: number | null = null;

    if (referralCode) {
      console.log('Referral code detected:', referralCode);
      const referrer = await getUserByReferralCode(referralCode);
      if (referrer && referrer.telegram_id !== telegramId) {
        referredBy = referrer.telegram_id;
      }
    }

    const existingUser = await getUserByTelegramId(telegramId);
    
    if (existingUser) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
      if (!existingUser.referred_by && !referralCode) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –ø—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
        const welcomeMessage = `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${firstName}!\n\n` +
          `‚ùå –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App.\n\n` +
          `üîë –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –ø–æ–ø—Ä–æ—Å–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —É –¥—Ä—É–≥–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n` +
          `üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n` +
          `/status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\n` +
          `/help - –ü–æ–º–æ—â—å`;

        return await ctx.reply(welcomeMessage);
      }

      const referralLink = `https://t.me/${ctx.me.username}?start=${existingUser.referral_code}`;
      
      let welcomeMessage = `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${firstName}!\n\n` +
        `‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App!\n\n` +
        `üí∞ –í–∞—à–∏ –º–æ–Ω–µ—Ç—ã: ${existingUser.coins}\n` +
        `üë• –í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã: ${existingUser.referral_count}\n\n` +
        `üéØ –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n` +
        `–û—Ç–ø—Ä–∞–≤–ª—è–π –¥—Ä—É–∑—å—è–º –∏ –ø–æ–ª—É—á–∞–π +1 –º–æ–Ω–µ—Ç—É!\n\n` +
        `üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n` +
        `/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n` +
        `/status - –í–∞—à —Å—Ç–∞—Ç—É—Å –∏ –º–æ–Ω–µ—Ç—ã\n` +
        `/referral - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É\n` +
        `/help - –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è`;

      await ctx.reply(welcomeMessage);
      
      if (referredBy && !existingUser.referred_by) {
        await addReferral(referredBy, telegramId);
        await ctx.reply('üéâ –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ! –î—Ä—É–≥ –ø–æ–ª—É—á–∏–ª +1 –º–æ–Ω–µ—Ç—É.');
      }
    } else {
      // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      if (!referralCode) {
        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        const welcomeMessage = `üëã –ü—Ä–∏–≤–µ—Ç, ${firstName}!\n\n` +
          `‚ùå –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App –Ω—É–∂–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞.\n\n` +
          `üîë –ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Å—Å—ã–ª–∫—É —É –¥—Ä—É–≥–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n` +
          `üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n` +
          `/help - –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è`;

        return await ctx.reply(welcomeMessage);
      }

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π
      const newUser = await createUser(telegramId, username || null, firstName, lastName || null, referredBy);
      const referralLink = `https://t.me/${ctx.me.username}?start=${newUser.referral_code}`;
      
      let welcomeMessage = `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${firstName}!\n\n` +
        `‚úÖ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App!\n\n` +
        `üí∞ –í–∞—à–∏ –º–æ–Ω–µ—Ç—ã: ${newUser.coins}\n` +
        `üéØ –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n` +
        `–û—Ç–ø—Ä–∞–≤–ª—è–π –¥—Ä—É–∑—å—è–º –∏ –ø–æ–ª—É—á–∞–π +1 –º–æ–Ω–µ—Ç—É!\n\n` +
        `üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n` +
        `/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n` +
        `/status - –í–∞—à —Å—Ç–∞—Ç—É—Å –∏ –º–æ–Ω–µ—Ç—ã\n` +
        `/referral - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É\n` +
        `/help - –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è`;

      if (referredBy) {
        await addReferral(referredBy, telegramId);
        welcomeMessage += '\n\nüéâ –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ! –î—Ä—É–≥ –ø–æ–ª—É—á–∏–ª +1 –º–æ–Ω–µ—Ç—É.';
      }

      await ctx.reply(welcomeMessage);
    }
  } catch (error) {
    console.error('Error in /start:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /status
bot.command('status', async (ctx) => {
  try {
    const telegramId = ctx.from?.id;
    if (!telegramId) return;

    const user = await getUserByTelegramId(telegramId);
    if (!user) {
      return await ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
    }

    const referralLink = `https://t.me/${ctx.me.username}?start=${user.referral_code}`;
    
    let statusMessage = `üìä –í–∞—à —Å—Ç–∞—Ç—É—Å:\n\n`;

    if (!user.referred_by) {
      statusMessage += `‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App\n\n` +
        `üîë –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç –¥—Ä—É–≥–∞\n\n`;
    } else {
      statusMessage += `‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App\n\n`;
    }

    statusMessage += `üí∞ –ú–æ–Ω–µ—Ç—ã: ${user.coins}\n` +
      `üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${user.referral_count}\n` +
      `üéØ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ${user.referral_code}\n\n`;

    if (user.referral_count > 0) {
      statusMessage += `üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n` +
        `–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ!`;
    } else {
      statusMessage += `üìä –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É!`;
    }

    await ctx.reply(statusMessage);
  } catch (error) {
    console.error('Error in /status:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /referral
bot.command('referral', async (ctx) => {
  try {
    const telegramId = ctx.from?.id;
    if (!telegramId) return;

    const user = await getUserByTelegramId(telegramId);
    if (!user) {
      return await ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ Mini App
    if (!user.referred_by) {
      return await ctx.reply('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App.\n\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∞.');
    }

    // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø
    const referralLink = `https://t.me/${ctx.me.username}?start=${user.referral_code}`;
    
    const referralMessage = `üéØ –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n\n${referralLink}\n\n` +
      `–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ!\n\n` +
      `üí∞ –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –º–æ–Ω–µ—Ç—ã: ${user.coins}\n` +
      `üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: ${user.referral_count}\n\n` +
      `–í–∞—à–∏ –¥—Ä—É–∑—å—è –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø –∫ Mini App –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ!`;
    
    await ctx.reply(referralMessage);

  } catch (error) {
    console.error('Error in /referral:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.command('help', async (ctx) => {
  const helpMessage = `
ü§ñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
/status - –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à —Å—Ç–∞—Ç—É—Å –∏ –º–æ–Ω–µ—Ç—ã
/referral - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ

üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –¥—Ä—É–≥–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start —Å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Mini App
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /referral —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é —Å—Å—ã–ª–∫—É
4. –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +1 –º–æ–Ω–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ

üì± Mini App –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π!
  `;
  
  await ctx.reply(helpMessage);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (ctx) => {
  if (ctx.message.text && !ctx.message.text.startsWith('/')) {
    await ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.');
  }
});

// Webhook endpoint
app.post('/webhook', webhookCallback(bot, 'express'));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err) => {
  console.error('Bot error:', err);
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
  console.log(`üöÄ Bot server running on port ${PORT}`);
  console.log(`üåê Health check: http://localhost:${PORT}/health`);
});

// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º webhooks, –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö
if (process.env.RENDER_EXTERNAL_URL) {
  const webhookUrl = `${process.env.RENDER_EXTERNAL_URL}/webhook`;
  bot.api.setWebhook(webhookUrl).then(() => {
    console.log(`‚úÖ Webhook set to: ${webhookUrl}`);
  }).catch(console.error);
}